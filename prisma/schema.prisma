generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  phone                 String                 @unique
  password              String
  role                  UserRole               @default(USER)
  status                UserStatus             @default(PENDING)
  category              UserCategory           @default(MODERATE)
  trustScore            Int                    @default(50)
  firstName             String
  lastName              String
  dateOfBirth           DateTime
  maritalStatus         MaritalStatus
  nationalId            String                 @unique
  nationalIdVerified    Boolean                @default(false)
  profilePicture        String?
  emailVerified         Boolean                @default(false)
  phoneVerified         Boolean                @default(false)
  twoFactorEnabled      Boolean                @default(false)
  totalBorrowed         Decimal                @default(0) @db.Decimal(15, 2)
  totalLent             Decimal                @default(0) @db.Decimal(15, 2)
  totalRepaid           Decimal                @default(0) @db.Decimal(15, 2)
  currentDebt           Decimal                @default(0) @db.Decimal(15, 2)
  walletBalance         Decimal                @default(0) @db.Decimal(15, 2)
  totalLoansTaken       Int                    @default(0)
  totalLoansGiven       Int                    @default(0)
  loansPaidOnTime       Int                    @default(0)
  loansPaidLate         Int                    @default(0)
  loansDefaulted        Int                    @default(0)
  avgRepaymentTime      Int?
  isDeleted             Boolean                @default(false)
  deletedAt             DateTime?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  lastLoginAt           DateTime?
  address               Address?
  familyDetails         FamilyDetails?
  loansAsBorrower       Loan[]                 @relation("BorrowerLoans")
  loansAsLender         Loan[]                 @relation("LenderLoans")
  guarantorLoans        LoanGuarantor[]
  loanOffers            LoanOffer[]            @relation("LoanOfferLender")
  loanRequests          LoanRequest[]
  notifications         Notification[]
  receivedTransactions  Transaction[]          @relation("ReceivedTransactions")
  sentTransactions      Transaction[]          @relation("SentTransactions")
  trustScoreHistory     TrustScoreHistory[]
  verificationDocuments VerificationDocument[]

  @@index([category])
  @@index([trustScore])
  @@index([currentDebt])
  @@index([isDeleted])
}

model Country {
  id          String     @id @default(cuid())
  name        String     @unique
  code        String     @unique
  currency    String
  phonePrefix String
  isActive    Boolean    @default(true)
  isDeleted   Boolean    @default(false)
  addresses   Address[]
  provinces   Province[]

  @@index([name])
  @@index([isActive])
}

model Province {
  id        String     @id @default(cuid())
  name      String
  code      String?
  countryId String
  isActive  Boolean    @default(true)
  isDeleted Boolean    @default(false)
  addresses Address[]
  districts District[]
  country   Country    @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([countryId, name])
  @@index([name])
  @@index([isActive])
}

model District {
  id         String    @id @default(cuid())
  name       String
  code       String?
  provinceId String
  isActive   Boolean   @default(true)
  isDeleted  Boolean   @default(false)
  addresses  Address[]
  province   Province  @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  sectors    Sector[]

  @@unique([provinceId, name])
  @@index([name])
  @@index([isActive])
}

model Sector {
  id         String    @id @default(cuid())
  name       String
  code       String?
  districtId String
  isActive   Boolean   @default(true)
  isDeleted  Boolean   @default(false)
  addresses  Address[]
  cells      Cell[]
  district   District  @relation(fields: [districtId], references: [id], onDelete: Cascade)

  @@unique([districtId, name])
  @@index([name])
  @@index([isActive])
}

model Cell {
  id        String    @id @default(cuid())
  name      String
  code      String?
  sectorId  String
  isActive  Boolean   @default(true)
  isDeleted Boolean   @default(false)
  addresses Address[]
  sector    Sector    @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  villages  Village[]

  @@unique([sectorId, name])
  @@index([name])
  @@index([isActive])
}

model Village {
  id        String    @id @default(cuid())
  name      String
  code      String?
  cellId    String
  isActive  Boolean   @default(true)
  isDeleted Boolean   @default(false)
  addresses Address[]
  cell      Cell      @relation(fields: [cellId], references: [id], onDelete: Cascade)

  @@unique([cellId, name])
  @@index([name])
  @@index([isActive])
}

model Address {
  id         String    @id @default(cuid())
  userId     String    @unique
  street     String?
  countryId  String
  provinceId String?
  districtId String?
  sectorId   String?
  cellId     String?
  villageId  String?
  latitude   Float?
  longitude  Float?
  isDeleted  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  cell       Cell?     @relation(fields: [cellId], references: [id])
  country    Country   @relation(fields: [countryId], references: [id])
  district   District? @relation(fields: [districtId], references: [id])
  province   Province? @relation(fields: [provinceId], references: [id])
  sector     Sector?   @relation(fields: [sectorId], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  village    Village?  @relation(fields: [villageId], references: [id])
}

model FamilyDetails {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  spouseName               String?
  spouseNationalId         String?
  spousePhone              String?
  fatherName               String?
  fatherNationalId         String?
  fatherPhone              String?
  motherName               String?
  motherNationalId         String?
  motherPhone              String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id])
}

model VerificationDocument {
  id              String             @id @default(cuid())
  userId          String
  documentType    DocumentType
  documentUrl     String
  status          VerificationStatus @default(PENDING)
  verifiedBy      String?
  verifiedAt      DateTime?
  rejectionReason String?
  isDeleted       Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([isDeleted])
}

model Loan {
  id                   String              @id @default(cuid())
  loanNumber           String              @unique @default(uuid())
  borrowerId           String
  lenderId             String
  amount               Decimal             @db.Decimal(15, 2)
  interestRate         Decimal             @default(6.0) @db.Decimal(5, 2)
  durationDays         Int
  purpose              String?
  disbursedAt          DateTime?
  dueDate              DateTime?
  repaidAt             DateTime?
  totalAmount          Decimal             @db.Decimal(15, 2)
  amountPaid           Decimal             @default(0) @db.Decimal(15, 2)
  amountDue            Decimal             @db.Decimal(15, 2)
  status               LoanStatus          @default(PENDING)
  isLate               Boolean             @default(false)
  lateDays             Int                 @default(0)
  penaltyAmount        Decimal             @default(0) @db.Decimal(15, 2)
  agreementUrl         String?
  signedByBorrower     Boolean             @default(false)
  signedByLender       Boolean             @default(false)
  isDeleted            Boolean             @default(false)
  deletedAt            DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  paymentProofDocument String?
  borrower             User                @relation("BorrowerLoans", fields: [borrowerId], references: [id])
  lender               User                @relation("LenderLoans", fields: [lenderId], references: [id])
  guarantors           LoanGuarantor[]
  repayments           Repayment[]
  transactions         Transaction[]
  trustScoreHistories  TrustScoreHistory[]

  @@index([borrowerId, status])
  @@index([lenderId, status])
  @@index([dueDate])
  @@index([status])
  @@index([isDeleted])
}

model LoanRequest {
  id              String            @id @default(cuid())
  borrowerId      String
  loanNumber      String            @unique @default(uuid())
  amount          Decimal           @db.Decimal(15, 2)
  minAmount       Decimal?          @db.Decimal(15, 2)
  interestRate    Decimal           @default(6.0) @db.Decimal(5, 2)
  durationDays    Int
  purpose         String?
  amountFunded    Decimal           @default(0) @db.Decimal(15, 2)
  amountNeeded    Decimal           @db.Decimal(15, 2)
  status          LoanRequestStatus @default(OPEN)
  fundingDeadline DateTime?
  isPublic        Boolean           @default(true)
  maxLenders      Int               @default(1)
  isDeleted       Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  expiresAt       DateTime?
  loanOffers      LoanOffer[]
  borrower        User              @relation(fields: [borrowerId], references: [id], onDelete: Cascade)

  @@index([borrowerId])
  @@index([status, isPublic])
  @@index([expiresAt])
  @@index([isDeleted])
}

model LoanOffer {
  id             String          @id @default(cuid())
  loanRequestId  String
  lenderId       String
  amount         Decimal         @db.Decimal(15, 2)
  interestRate   Decimal         @db.Decimal(5, 2)
  status         LoanOfferStatus @default(PENDING)
  isCounterOffer Boolean         @default(false)
  message        String?
  isDeleted      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  lender         User            @relation("LoanOfferLender", fields: [lenderId], references: [id], onDelete: Cascade)
  loanRequest    LoanRequest     @relation(fields: [loanRequestId], references: [id], onDelete: Cascade)

  @@unique([loanRequestId, lenderId])
  @@index([lenderId, status])
  @@index([isDeleted])
}

model LoanGuarantor {
  id        String   @id @default(cuid())
  loanId    String
  userId    String
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  loan      Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([loanId, userId])
  @@index([userId])
}

model Transaction {
  id              String            @id @default(cuid())
  transactionId   String            @unique @default(uuid())
  senderId        String
  receiverId      String
  loanId          String?
  amount          Decimal           @db.Decimal(15, 2)
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  paymentMethod   PaymentMethod?
  gatewayId       String?
  gatewayResponse Json?
  description     String?
  fees            Decimal           @default(0) @db.Decimal(15, 2)
  netAmount       Decimal           @db.Decimal(15, 2)
  isDeleted       Boolean           @default(false)
  deletedAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  completedAt     DateTime?
  repayments      Repayment[]
  loan            Loan?             @relation(fields: [loanId], references: [id])
  receiver        User              @relation("ReceivedTransactions", fields: [receiverId], references: [id])
  sender          User              @relation("SentTransactions", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@index([loanId])
  @@index([type, status])
  @@index([createdAt])
  @@index([isDeleted])
}

model Repayment {
  id                String       @id @default(cuid())
  loanId            String
  installmentNumber Int
  dueAmount         Decimal      @db.Decimal(15, 2)
  paidAmount        Decimal      @default(0) @db.Decimal(15, 2)
  dueDate           DateTime
  paidDate          DateTime?
  isLate            Boolean      @default(false)
  lateDays          Int          @default(0)
  penaltyAmount     Decimal      @default(0) @db.Decimal(15, 2)
  status            String       @default("PENDING")
  transactionId     String?
  isDeleted         Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  loan              Loan         @relation(fields: [loanId], references: [id], onDelete: Cascade)
  transaction       Transaction? @relation(fields: [transactionId], references: [id])

  @@index([loanId])
  @@index([dueDate])
  @@index([status])
  @@index([isDeleted])
}

model TrustScoreHistory {
  id        String   @id @default(cuid())
  userId    String
  loanId    String?
  oldScore  Int
  newScore  Int
  change    Int
  reason    String
  metadata  Json?
  createdAt DateTime @default(now())
  loan      Loan?    @relation(fields: [loanId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loanId])
  @@index([createdAt])
  @@index([reason])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  isDeleted Boolean          @default(false)
  createdAt DateTime         @default(now())
  readAt    DateTime?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@index([isDeleted])
}

model PlatformSettings {
  id                       String   @id @default(cuid())
  platformFeePercentage    Decimal  @default(1.0) @db.Decimal(5, 2)
  maxLoanAmount            Decimal  @default(10000) @db.Decimal(15, 2)
  minLoanAmount            Decimal  @default(10) @db.Decimal(15, 2)
  lateFeePercentage        Decimal  @default(2.0) @db.Decimal(5, 2)
  maxLateDaysBeforeDefault Int      @default(30)
  trustScoreWeight         Json
  minInterestRate          Decimal  @default(1.0) @db.Decimal(5, 2)
  maxInterestRate          Decimal  @default(20.0) @db.Decimal(5, 2)
  minLoanDurationDays      Int      @default(7)
  maxLoanDurationDays      Int      @default(365)
  requireGuarantor         Boolean  @default(false)
  minGuarantors            Int      @default(0)
  maxGuarantors            Int      @default(3)
  updatedAt                DateTime @updatedAt
  updatedBy                String
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BLOCKED
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum DocumentType {
  NATIONAL_ID
  PASSPORT
  UTILITY_BILL
  SELFIE
  BANK_STATEMENT
  PAYSLIP
}

enum LoanStatus {
  PENDING
  ACTIVE
  REPAID
  DEFAULTED
  CANCELLED
  OVERDUE
  PAYMENT_INITIATED
}

enum LoanRequestStatus {
  OPEN
  FUNDED
  PARTIAL
  CANCELLED
  EXPIRED
}

enum LoanOfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum TransactionType {
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
  WALLET_DEPOSIT
  WALLET_WITHDRAWAL
  FEE
  PENALTY
  REFUND
  GUARANTOR_PAYMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  FLUTTERWAVE
  MOBILE_MONEY
  BANK_TRANSFER
  WALLET
}

enum NotificationType {
  LOAN_REQUEST
  LOAN_OFFER
  LOAN_APPROVED
  LOAN_DISBURSED
  REPAYMENT_REMINDER
  REPAYMENT_RECEIVED
  LOAN_OVERDUE
  CATEGORY_UPDATED
  VERIFICATION_STATUS
  SYSTEM_ANNOUNCEMENT
  GUARANTOR_REQUEST
}

enum UserCategory {
  EXCELLENT
  GOOD
  TRUSTABLE
  MODERATE
  RISKY
  DEFAULT
}
